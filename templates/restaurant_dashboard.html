
{% extends "base.html" %}

{# üîπ Manifest override ONLY #}
{% block manifest %}
<link rel="manifest" href="{{ url_for('static', filename='manifest-restaurant.json') }}">
<meta name="theme-color" content="#dc2626">
{% endblock %}

{# üö´ Disable bottom navigation on this page #}
{% block bottom_nav %}{% endblock %}

{% block title %}Restaurant_Dashboard{% endblock %}

{# ‚úÖ Restaurant-specific Install Button #}
{% block install_button %}
<button id="installApp" class="install-fab">
  üì≤ Install Restaurant App
</button>
{% endblock %}

{% block content %}

<style>
/* ===== GLOBAL STYLES ===== */
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#f4f7fa,#e9eef5); color:#333; }

/* ===== DASHBOARD CONTAINER ===== */
.dashboard-container {
    max-width: 1300px;
    margin: 30px auto;
    padding: 30px;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 20px 45px rgba(0,0,0,0.08);
}

/* ===== HEADINGS ===== */
h2 { font-size: 26px; margin-bottom: 8px; }
h3 { font-size: 18px; margin-bottom: 15px; color:#666; }

/* ===== TOP LINKS ===== */
.top-links { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:25px; }
.top-links a {
    padding:12px 20px; border-radius:12px; color:#fff; font-weight:700; transition:0.3s; text-decoration:none;
}
.top-links a.delivery-boys { background: linear-gradient(135deg,#43a047,#66bb6a); }
.top-links a.logout { background: linear-gradient(135deg,#e53935,#ef5350); }
.top-links a:hover { transform:scale(1.05); box-shadow:0 10px 25px rgba(0,0,0,0.2); }

/* ===== FILTERS ===== */
.filters, .filter-inline { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
.filters input, .filters select, .filter-inline input, .filter-inline select {
    padding:10px 14px; border-radius:10px; border:1px solid #ccc; font-size:14px; transition:0.3s;
}
.filters input:focus, .filters select:focus, .filter-inline input:focus, .filter-inline select:focus {
    outline:none; border-color:#ff5722; box-shadow:0 0 10px rgba(255,87,34,0.25);
}

/* ===== TABLE STYLES ===== */
.table-wrapper { overflow-x:auto; margin-bottom:30px; }
table { width:100%; border-collapse:collapse; border-radius:14px; overflow:hidden; }
thead { background: linear-gradient(135deg,#22ffda,#068372); color:#fff; position:sticky; top:0; z-index:2; }
th, td { padding:14px; text-align:center; font-size:14px; }
tbody tr { transition:0.2s ease; }
tbody tr:nth-child(even) { background:#fafafa; }
tbody tr:hover { background:#fff3e0; }

/* ===== STATUS BADGES ===== */
.status { padding:6px 14px; border-radius:30px; font-size:12px; font-weight:700; color:#fff; display:inline-block; }
.status.Pending { background:#ff9800; } 
.status.Accepted {
    background: #048061;   /* blue */
    color: white;
}
.status.Out-for-Delivery {
  background: linear-gradient(135deg, #ff9800, #ff5722);
  color: #fff;
  box-shadow: 0 4px 10px rgba(255, 87, 34, 0.35);
  animation: deliveryPulse 1.4s infinite;
}
.status.Preparing { background:#2196f3; } 


.status.Ready { background:#9c27b0; }
.status.Out-for-Delivery {
    background: #ffeb3b;
    color: #4caf50;
}
.status.Delivered { background:#4caf50; }
.status.Cancelled { background:#f44336; }

/* ===== PAYMENT BADGES ===== */
.payment-badge { padding:6px 14px; border-radius:30px; font-size:12px; font-weight:700; color:#fff; display:inline-block; }
.payment-badge.COD { background:#ff9800; }
.payment-badge.Online { background:#4caf50; }
.payment-badge.NotCollected { background:#9e9e9e; }

/* ===== BUTTONS ===== */
.assign-btn { background: linear-gradient(135deg,#2196f3,#42a5f5); color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer; }
.update-btn { background: linear-gradient(135deg,#ff5722,#ff7043); color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer; }

/* ===== NEW ORDER BADGE ===== */
.new-order-badge {
    position: fixed; top:20px; right:20px;
    background: linear-gradient(135deg,#ff5722,#ff7043);
    color:#fff; padding:14px 22px; border-radius:14px; font-weight:700;
    box-shadow:0 10px 25px rgba(0,0,0,0.3);
    display:none; z-index:9999;
}

/* Feedback column reason in red */
td[data-label="Feedback"] {
    color: red;
    font-weight: 600;
}
/* Feedback badge */
.feedback-badge {
    display: inline-block;
    background-color: #f44336; /* red background */
    color: white;              /* text color */
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    max-width: 200px;          /* optional: prevent very long text */
    white-space: nowrap;       /* keep in single line */
    overflow: hidden;
    text-overflow: ellipsis;   /* show ... if too long */
    text-align: center;
}/* ===== CARDS (default mobile view) ===== */
/* Table wrapper to allow horizontal scroll */
/* ===== Mobile Cards ===== */
.stats-cards-wrapper {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding: 15px 0;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
}

.stats-card {
    flex: 0 0 auto;
    min-width: 140px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    padding: 15px;
    text-align: center;
}

.stats-card strong {
    display: block;
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
}

.stats-card span {
    font-size: 16px;
    color: #333;
    font-weight: 700;
}

/* ===== Horizontal Table ===== */
.stats-table-wrapper {
    display: none; /* hide by default on mobile */
    overflow-x: auto;
    padding: 15px 0;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
}

.stats-table {
    border-collapse: collapse;
    min-width: 1000px; /* force horizontal scroll if needed */
    width: 100%;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-radius: 12px;
}

.stats-table th, .stats-table td {
    padding: 12px 15px;
    text-align: center;
}

.stats-table th {
    background: #f4f4f4;
    color: #333;
    font-weight: 600;
}

.stats-table tbody tr:nth-child(even) {
    background: #f9f9f9;
}

.stats-table td {
    font-weight: 500;
    color: #555;
}

/* ===== MEDIA QUERIES ===== */
@media (min-width: 769px) {
    .stats-cards-wrapper {
        display: none; /* hide cards on desktop */
    }
    .stats-table-wrapper {
        display: block; /* show horizontal table on desktop */
    }
}
/* Base button style */
.top-links .btn, .btn {
    display: inline-block;
    padding: 10px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    transition: all 0.3s ease;
    margin-right: 10px;
    font-size: 16px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* Hover effect */
.top-links .btn:hover, .btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.2);
}

/* Individual colors */
.delivery-boys { background-color: #ff9800; }       /* orange */
.manage-offers { background-color: #ff5722; }       /* deep orange */
.edit-card { background-color: #4caf50; }           /* green */
.reports { background-color: #673ab7; }            /* purple */
.logout { background-color: #f44336; }             /* red */
.view-delivery-persons { background-color: #009688; } /* teal */

</style>

<div class="dashboard-container">
<h2>Welcome, {{ session['restaurant_name'] }}</h2>
<div id="newOrderBadge" class="new-order-badge">üîî New Order Received!</div>
<!-- TOP LINKS -->
<div class="top-links">
    <a href="{{ url_for('delivery_boys_cod_summary') }}" class="btn delivery-boys">
        Delivery Boys COD
    </a>

    <a href="{{ url_for('manage_offers', restaurant_id=session['restaurant_id']) }}" class="btn manage-offers">
        üî• Manage Offers
    </a>

    <a href="{{ url_for('edit_restaurant_card', restaurant_id=session['restaurant_id']) }}" class="btn edit-card">
        ‚úèÔ∏è Edit Restaurant Card
    </a>

    <a href="{{ url_for('restaurant_reports') }}" class="btn reports">
        üìä Reports
    </a>

    <a href="{{ url_for('restaurant_logout') }}" class="btn logout">
        Logout
    </a>
</div>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('restaurant_delivery_persons') }}" class="btn view-delivery-persons">
        View All Delivery Persons
    </a>
</div>

<!-- FILTERS -->
<div class="filter-inline">
    <input type="text" id="searchInput" placeholder="Search Order ID, Customer, Phone">
    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <select id="statusFilter">
        <option value="">All Status</option>
        <option value="Pending">Pending</option>
        <option value="Accepted">Accepted</option>
        <option value="Preparing">Preparing</option>
        <option value="Ready">Ready</option>
        <option value="Out for Delivery">Out for Delivery</option>
        <option value="Delivered">Delivered</option>
        <option value="Cancelled">Cancelled</option>
    </select>
    <button id="searchBtn">Search</button>
    <button id="clearFilters">Clear</button>
</div>
<!-- CARDS (mobile) -->
<div class="stats-cards-wrapper">
    <div class="stats-card"><strong>Today Orders</strong><span>{{ stats.today_orders }}</span></div>
    <div class="stats-card"><strong>Delivered Today</strong><span>{{ stats.delivered_today }}</span></div>
    <div class="stats-card"><strong>Pending Today</strong><span>{{ stats.pending_today }}</span></div>
    <div class="stats-card"><strong>Cancelled Today</strong><span>{{ stats.cancelled_today }}</span></div>
    <div class="stats-card"><strong>Active Orders</strong><span>{{ stats.active_orders }}</span></div>
    <div class="stats-card"><strong>Today Earnings</strong><span>‚Çπ{{ stats.today_earnings }}</span></div>
    <div class="stats-card"><strong>COD Amount</strong><span>‚Çπ{{ stats.today_cod_amount }}</span></div>
    <div class="stats-card"><strong>Online Amount</strong><span>‚Çπ{{ stats.today_online_amount }}</span></div>
    <div class="stats-card"><strong>Weekly Orders</strong><span>{{ stats.weekly_orders }}</span></div>
    <div class="stats-card"><strong>Weekly Earnings</strong><span>‚Çπ{{ stats.weekly_earnings }}</span></div>
    <div class="stats-card"><strong>Weekly Delivered</strong><span>{{ stats.weekly_delivered_orders }}</span></div>
</div>

<!-- TABLE (desktop) -->
<h3>Today's Overview</h3>

<div class="stats-table-wrapper">
    <table class="stats-table">
        <thead>
            <tr>
                <th>Today Orders</th>
                <th>Delivered Today</th>
                <th>Pending Today</th>
                <th>Cancelled Today</th>
                <th>Active Orders</th>
                <th>Today Earnings</th>
                <th>COD Amount</th>
                <th>Online Amount</th>
                <th>Weekly Orders</th>
                <th>Weekly Earnings</th>
                <th>Weekly Delivered</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ stats.today_orders }}</td>
                <td>{{ stats.delivered_today }}</td>
                <td>{{ stats.pending_today }}</td>
                <td>{{ stats.cancelled_today }}</td>
                <td>{{ stats.active_orders }}</td>
                <td>‚Çπ{{ stats.today_earnings }}</td>
                <td>‚Çπ{{ stats.today_cod_amount }}</td>
                <td>‚Çπ{{ stats.today_online_amount }}</td>
                <td>{{ stats.weekly_orders }}</td>
                <td>‚Çπ{{ stats.weekly_earnings }}</td>
                <td>{{ stats.weekly_delivered_orders }}</td>
            </tr>
        </tbody>
    </table>
</div>

</table>
</div>
<!-- ORDERS TABLE -->
{% for category in ['Today','Yesterday','Older'] %}
<h3>{{ category }} Orders</h3>
{% set filtered_orders = orders|selectattr("day_category","equalto",category)|list %}
{% if filtered_orders %}
<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Order ID</th>
<th>Customer</th>
<th>Items</th>
<th>Qty√óPrice</th>
<th>Total</th>
<th>Status</th>
<th>Placed</th>
<th>Location</th>
<th>Assign Delivery</th>
<th>Update Status</th>
<th>Payment</th>
<th>Cancel Reason</th>
<th>Feedback</th>
</tr>
</thead>
<tbody>
{% for order in filtered_orders %}
<tr data-status="{{ order.status }}" data-order-id="{{ order.order_id }}">

<td data-label="Order ID">{{ order.order_id }}</td>
<td data-label="Customer">{{ order.customer_name }}<br>{{ order.phone }}</td>
<td data-label="Items">
{% for item in order.items %}‚Ä¢ {{ item.item_name }}<br>{% endfor %}
</td>
<td data-label="Qty√óPrice">
{% for item in order.items %}{{ item.quantity }} √ó ‚Çπ{{ item.price }}<br>{% endfor %}
</td>
<td data-label="Total" style="text-align:left;">
    <strong>Items:</strong> ‚Çπ{{ order.items_total }}<br>
    <strong>Delivery:</strong> ‚Çπ{{ order.delivery_charge or 0 }}<br>
    <strong>Discount:</strong> ‚Çπ{{ order.discount or 0 }}{% if order.coupon_used %} ({{ order.coupon_used }}){% endif %}<br>
    <strong>R-Offer:</strong> ‚Çπ{{ order.restaurant_offer_discount or 0 }}<br>

    <hr style="margin:4px 0;">

    <strong>Total:</strong> ‚Çπ{{ order.final_total }}
</td>
<td data-label="Status"><span class="status {{ order.status }}">{{ order.status }}</span></td>
<td data-label="Placed">{{ order.created_at.strftime('%d-%m-%Y %H:%M') }}</td>
<td data-label="Location">
    {{ order.house_no }}, {{ order.landmark }}, {{ order.city }},
    {{ order.state }} - {{ order.pincode }}

    {% if order.customer_lat and order.customer_lng %}
        <br>
        <a href="{{ url_for('track_order', order_id=order.id) }}"
           class="map-btn">
           üìç map
        </a>
    {% else %}
        <br><span style="color:red;">Location not shared</span>
    {% endif %}
</td>


<td data-label="Assign Delivery">
  <form method="POST" action="{{ url_for('restaurant_assign_delivery', order_id=order.id) }}">
    <select name="delivery_person_id" required>
      <option value="">Select</option>
      {% for dp in delivery_persons %}
        <option value="{{ dp.id }}" {% if order.delivery_person_id == dp.id %}selected{% endif %}>{{ dp.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="assign-btn">Assign</button>
  </form>
</td>

<td data-label="Update Status">
  <form method="POST" action="{{ url_for('update_status', order_id=order.id) }}">
    <select name="status">

      <option value="Pending" {% if order.status=='Pending' %}selected{% endif %}>Pending</option>
      <option value="Accepted" {% if order.status=='Accepted' %}selected{% endif %}>Accepted</option>
      <option value="Preparing" {% if order.status=='Preparing' %}selected{% endif %}>Preparing</option>
      <option value="Ready" {% if order.status=='Ready' %}selected{% endif %}>Ready</option>
      <option value="Out for Delivery" {% if order.status=='Out for Delivery' %}selected{% endif %}>Out for Delivery</option>

      <!-- üîí DELIVERY CONTROLLED STATES (READ ONLY) -->
      <option value="Started" {% if order.status=='Started' %}selected{% endif %} disabled>üöö Delivery Started</option>
      <option value="Delivered" {% if order.status=='Delivered' %}selected{% endif %} disabled>‚úî Delivered</option>
      <option value="Cancelled" {% if order.status=='Cancelled' %}selected{% endif %}>Cancelled</option>

    </select>
      <button type="submit" class="update-btn">Update</button>
  </form>
</td>


  
 

<td data-label="Payment">
{% if order.payment_type=='COD' %}<span class="payment-badge COD">COD</span>
{% elif order.payment_type=='Online' %}<span class="payment-badge Online">Online</span>
{% else %}<span class="payment-badge NotCollected">Not Collected</span>{% endif %}
</td>

<td data-label="Cancel Reason">{{ order.cancel_reason or '-' }}</td>
<td data-label="Feedback">
    {% if order.not_delivered_reason %}
        <span class="feedback-badge">{{ order.not_delivered_reason }}</span>
    {% else %}
        <span style="color: gray;">-</span>
    {% endif %}
</td>

</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<p>No {{ category.lower() }} orders.</p>
{% endif %}
{% endfor %}
<div id="map" style="height: 300px; width: 100%; margin-bottom: 20px;"></div>



<script>
// ===== FILTERS =====
function applyFilters() {
    const searchValue = document.getElementById("searchInput").value.trim().toLowerCase();
    const statusValue = document.getElementById("statusFilter").value.trim().toLowerCase();
    const rows = document.querySelectorAll("tbody tr");
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        const rowStatus = (row.getAttribute("data-status")||"").toLowerCase();
        row.style.display = ((searchValue && !text.includes(searchValue)) || (statusValue && rowStatus!=statusValue)) ? "none" : "";
    });
}
document.getElementById("searchBtn").addEventListener("click", applyFilters);
document.getElementById("clearFilters").addEventListener("click", function(){
    document.getElementById("searchInput").value="";
    document.getElementById("statusFilter").value="";
    applyFilters();
});
document.getElementById("searchInput").addEventListener("keyup", e=>{if(e.key==="Enter") applyFilters();});

// ===== NEW ORDER SOUND & POPUP =====
let lastOrderId = "{{ orders[0].order_id if orders else '' }}";
const notifySound = new Audio("/static/sounds/neworder.mp3");

function showPopup(msg){
    const badge = document.getElementById("newOrderBadge");
    badge.innerHTML = msg;
    badge.style.display = "block";
    setTimeout(() => badge.style.display = "none", 4000);
}

setInterval(() => {
    fetch(window.location.href)
        .then(r => r.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // Update tables (same as before)
            const updatedTables = doc.querySelectorAll("table tbody");
            const currentTables = document.querySelectorAll("table tbody");
            updatedTables.forEach((ut, i) => {
                if (currentTables[i]) {
                    currentTables[i].innerHTML = ut.innerHTML;
                }
            });

            // üî• Detect ONLY newest order
            const firstRow = doc.querySelector("tbody tr[data-order-id]");
            if (!firstRow) return;

            const newOrderId = firstRow.getAttribute("data-order-id");

            if (newOrderId && newOrderId !== lastOrderId) {
                notifySound.play();
                showPopup("üîî New Order Received!");
                lastOrderId = newOrderId;
            }
        })
        .catch(console.error);
}, 8000);

</script>


{% endblock %}
