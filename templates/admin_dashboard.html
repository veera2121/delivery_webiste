<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Admin Dashboard</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
body {
    font-family: "Inter", sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
    color: #333;
    overflow-x: hidden; /* üî• STOP HORIZONTAL SCROLL */
}

.container { 
    max-width: 1200px; 
    margin: auto; 
    overflow-x: hidden; /* Extra safety */
}

h1, h2 { 
    color: #222; 
    margin-bottom: 15px; 
}

.top-links { 
    margin-bottom: 20px; 
}

.top-links a {
    text-decoration: none;
    color: #fff;
    background: #007bff;
    padding: 8px 15px;
    border-radius: 5px;
    margin-right: 10px;
    font-size: 14px;
    transition: 0.3s;
    white-space: nowrap;
}

.top-links a:hover { background: #0056b3; }

/* ----------- TABLE FIXES ------------ */
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 25px;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    table-layout: fixed; /* üî• Prevent overflow */
}

th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    word-wrap: break-word; /* üî• Long text wraps */
}

th { 
    background: #007bff; 
    color: #fff; 
    font-weight: 600; 
}

.status-Pending { color: orange; font-weight: bold; }
.status-Accepted { color: green; font-weight: bold; }
.status-Delivered { color: blue; font-weight: bold; }

/* ---------- GLOBAL FILTER ---------- */
form.global-filter { 
    margin-bottom: 20px; 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
    align-items: center; 
}

input[type="text"], input[type="date"], select {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
}

button { 
    padding: 6px 12px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
    background: #007bff; 
    color: #fff; 
    transition: 0.3s; 
}

button:hover { background: #0056b3; }

/* ------------ MOBILE VIEW ----------- */
@media (max-width: 768px) {

    table, thead, tbody, th, td, tr { 
        display: block; 
        width: 100%; 
    }

    thead tr { 
        display: none; 
    }

    tr { 
        margin-bottom: 15px; 
        border: 1px solid #ddd; 
        border-radius: 8px; 
        padding: 10px; 
        background: #fff; 
    }

    td { 
        padding: 10px; 
        position: relative; 
        border: none; 
        border-bottom: 1px solid #eee; 
    }

    td:before { 
        position: absolute; 
        top: 10px; 
        left: 10px; 
        font-weight: bold; 
        white-space: nowrap; 
    }

    td:nth-of-type(1):before { content: "Order ID"; }
    td:nth-of-type(2):before { content: "Restaurant"; }
    td:nth-of-type(3):before { content: "Customer"; }
    td:nth-of-type(4):before { content: "Phone"; }
    td:nth-of-type(5):before { content: "Items"; }
    td:nth-of-type(6):before { content: "Total"; }
    td:nth-of-type(7):before { content: "Status"; }
    td:nth-of-type(8):before { content: "Placed"; }
    td:nth-of-type(9):before { content: "Assign Delivery"; }
}
<style>
.coupon-used {
    background: #2ecc71;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.new-order {
    background-color: #fff9c4;
    transition: background-color 0.5s;
}
</style>


</style>
</head>

<body>
<div class="container">

<h1>Super Admin Dashboard</h1>

<div class="top-links">
    <a href="{{ url_for('add_restaurant') }}">Add Restaurant</a>
    <a href="{{ url_for('add_restaurant_user') }}">Add Restaurant User</a>
    <a href="{{ url_for('add_delivery_person') }}">Add Delivery Person</a> 
    <a href="{{ url_for('admin_reports') }}" style="background:#28a745;">
    üìä Reports
</a>

    <a href="{{ url_for('admin_logout') }}">Logout</a>
    <a href="{{ url_for('update_menus') }}">Update Menus from Google Sheets</a>  



  <a href="{{ url_for('admin_feedback') }}" class="menu-card">
    üìù Feedback / Issues
  </a>

<a href="{{ url_for('admin_delivery_settings') }}" class="delivery-btn">
    üöö Delivery Charge Control
</a>



</div>

<!-- ===== GLOBAL FILTER ===== -->
<form class="global-filter" method="GET">
    <input type="text" name="query" placeholder="Search Order ID, Customer, or Restaurant" value="{{ query }}">
    <input type="date" name="date" value="{{ date_filter }}">
    <select name="status">
        <option value="">All Status</option>
        <option value="Pending" {% if status_filter=='Pending' %}selected{% endif %}>Pending</option>
        <option value="Accepted" {% if status_filter=='Accepted' %}selected{% endif %}>Accepted</option>
        <option value="Delivered" {% if status_filter=='Delivered' %}selected{% endif %}>Delivered</option>
    </select>
    <button type="submit">Apply</button>
    <a href="{{ url_for('admin_dashboard') }}"><button type="button">Reset</button></a>
</form>

<!-- ===== PLATFORM STATISTICS ===== -->
<h2>Platform Overview</h2>
<table>
<tr>
    <th>Total Restaurants</th>
    <th>Total Orders Today</th>
    <th>Total Revenue Today</th>
    <th>Pending Orders</th>
    <th>Active Deliveries</th>
</tr>
<tr>
    <td>{{ restaurants|length }}</td>
    <td>{{ stats.total_orders_today }}</td>
    <td>‚Çπ{{ stats.total_revenue_today }}</td>
    <td>{{ stats.pending }}</td>
    <td>{{ stats.assigned }}</td>
</tr>
</table>

<!-- ===== RESTAURANT PERFORMANCE ===== -->
<h2>Restaurant Performance</h2>
<table>
<tr>
    <th>Restaurant</th>
    <th>Today Orders</th>
    <th>Today Earnings</th>
    <th>Weekly Orders</th>
    <th>Weekly Earnings</th>
    <th>Pending</th>
    <th>Completed</th>
    <th>View</th>
    <th>Edit</th>
</tr>
{% for r in restaurant_stats %}
<tr>
    <td>{{ r.name }}</td>
    <td>{{ r.today_orders }}</td>
    <td>‚Çπ{{ r.today_earnings }}</td>
    <td>{{ r.weekly_orders }}</td>
    <td>‚Çπ{{ r.weekly_earnings }}</td>
    <td>{{ r.pending }}</td>
    <td>{{ r.completed }}</td>
    <td><a href="{{ url_for('restaurant_dashboard') }}?id={{ r.id }}">Open</a></td>
    <td><a href="{{ url_for('edit_restaurant', restaurant_id=r.id) }}">Edit</a></td>
</tr>
{% endfor %}
</table>

<!-- ===== ALL ORDERS GROUPED BY DAY ===== -->

{% for category in ['Today','Yesterday','Older'] %}
<h2>{{ category }} Orders</h2>

{% set filtered_orders = orders|selectattr("day_category","equalto",category)|list %}
{% if filtered_orders %}

<table id="ordersTable">
    <thead>
        <tr>
            <th>Order ID</th>
            <th>Restaurant</th>
            <th>Customer</th>
            <th>Phone</th>
            <th>Items</th>
            <th>Coupon</th>
            <th>Discount (‚Çπ)</th>
            <th>Final Total (‚Çπ)</th>
            <th>Status</th>
            <th>Placed</th>
            <th>Assign Delivery</th>
        </tr>
    </thead>

    <tbody>
    {% for order in filtered_orders %}
        <tr>
            <td>{{ order.order_id }}</td>
            <td>{{ order.restaurant.name }}</td>
            <td>{{ order.customer_name }}</td>
            <td>{{ order.phone }}</td>

            <td>
                <ul>
                    {% for item in order.items %}
                    <li>{{ item.item_name }} x {{ item.quantity }} - ‚Çπ{{ item.price }}</li>
                    {% endfor %}
                </ul>
            </td>

            <!-- ‚úÖ Coupon Code -->
            <td>
                {% if order.coupon_used %}
                    <span class="coupon-used">{{ order.coupon_used }}</span>
                {% else %}
                    ‚Äî
                {% endif %}
            </td>

            <!-- ‚úÖ Discount -->
            <td>
                {% if order.discount %}
                    ‚Çπ{{ order.discount }}
                {% else %}
                    0
                {% endif %}
            </td>

            <!-- ‚úÖ Final Total (correct everywhere) -->
            <td><strong>‚Çπ{{ order.get_final_total() }}</strong></td>

            <td class="status-{{ order.status }}">{{ order.status }}</td>

            <td>{{ order.created_at.strftime('%d-%m-%Y %H:%M') }}</td>

            <td>
                <form method="POST" action="{{ url_for('restaurant_assign_delivery', order_id=order.id) }}">

                    <select name="delivery_person_id">
                        <option value="">Select</option>
                        {% for dp in delivery_persons %}
                        <option value="{{ dp.id }}"
                            {% if order.delivery_person_id == dp.id %}selected{% endif %}>
                            {{ dp.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="submit">Assign</button>
                </form>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% else %}
<p>No {{ category.lower() }} orders.</p>
{% endif %}
{% endfor %}


</div> 



<!-- Quick fix: update only tbody (no backend changes) -->
<script>
let lastOrderCount = {{ orders|length }};
const notifySound = new Audio("{{ url_for('static', filename='notify.mp3') }}");

async function quickRefresh() {
    try {
        const res = await fetch(window.location.href, {cache: "no-store"});
        const text = await res.text();
        const tmp = document.createElement("div");
        tmp.innerHTML = text;

        // Find the new tbody in fetched HTML
        const newTbody = tmp.querySelector("#ordersTable tbody");
        const currentTbody = document.querySelector("#ordersTable tbody");
        if (newTbody && currentTbody) {
            const newRows = newTbody.querySelectorAll("tr").length;
            if (newRows > lastOrderCount) {
                notifySound.play().catch(()=>{});
                // optional: add highlight to top new rows
                // after replacing, add .new-order to first (newRows - lastOrderCount) rows
            }

            // Replace only tbody HTML
            currentTbody.innerHTML = newTbody.innerHTML;

            // highlight new rows for a while
            if (newRows > lastOrderCount && lastOrderCount !== 0) {
                const countNew = newRows - lastOrderCount;
                const trs = currentTbody.querySelectorAll("tr");
                for (let i = 0; i < Math.min(countNew, trs.length); i++) {
                    trs[i].classList.add("new-order");
                    setTimeout(() => trs[i].classList.remove("new-order"), 4000);
                }
            }
            lastOrderCount = newRows;
        }
    } catch (err) {
        console.error("Quick refresh error:", err);
    }
}

setInterval(quickRefresh, 10000);
</script>


</body>
</html>
