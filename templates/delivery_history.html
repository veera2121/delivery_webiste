<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery History</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,sans-serif;
  background:#f4f6f8;
  margin:0;
}

.container{
  max-width:1200px;
  margin:15px auto;
  padding:12px;
}

h1{
  color:#ff5722;
  text-align:center;
  margin-bottom:10px;
}

.btn{
  display:inline-block;
  background:#2196f3;
  color:#fff;
  padding:8px 14px;
  border-radius:6px;
  text-decoration:none;
  font-weight:600;
  margin-bottom:12px;
}

/* ===== STATS ===== */
.stats-scroll{
  display:flex;
  gap:14px;
  overflow-x:auto;
  padding:10px 5px 15px;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
}
.stats-scroll::-webkit-scrollbar{ display:none; }
.stats-card{ min-width:240px; flex-shrink:0; background:#fff; border-radius:16px; padding:15px; box-shadow:0 8px 22px rgba(0,0,0,.1); scroll-snap-align:start; }
.stats-card h3{ margin:0 0 8px; font-size:16px; }
.stats-card p{ margin:4px 0; font-size:14px; }
.today{ background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border-left:5px solid #4caf50; }
.yesterday{ background:linear-gradient(135deg,#e3f2fd,#bbdefb); border-left:5px solid #2196f3; }
.older{ background:linear-gradient(135deg,#f3e5f5,#e1bee7); border-left:5px solid #9c27b0; }

/* ===== FILTER BAR ===== */
.filter-bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:14px;
}
.filter-bar input, .filter-bar select, .filter-bar button{
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:14px;
}

/* ===== ORDER CARD ===== */
.order-card{
  background:#fff;
  border-radius:14px;
  padding:14px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.05);
  position:relative;
}
.status-badge{
  position:absolute;
  top:12px;
  right:12px;
  background:#4caf50;
  color:#fff;
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
}
ul{ padding-left:18px; margin:6px 0; }
ul li{ font-size:13px; }
.payment-badge{ padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600; color:#fff; }
.COD{background:#ff9800} .Online{background:#4caf50} .NotCollected{background:#9e9e9e}

/* ===== MOBILE ===== */
@media(max-width:600px){
  .stats-card p{font-size:18px}
  .order-card{padding:12px}
}  
</style>
</head>

<body>
<div class="container">

<h1>Delivery History - {{ session.delivery_person_name }}</h1>
<a href="{{ url_for('delivery_dashboard') }}" class="btn">â¬… Back to Dashboard</a>

<!-- FILTER BAR -->
<div class="filter-bar">
  <input type="text" id="searchInput" placeholder="ðŸ” Search by Order ID / Customer / Phone">
  <select id="statusFilter">
    <option value="">All Status</option>
    <option value="Delivered">Delivered</option>
    <option value="Customer Not Available">Customer Not Available</option>
    <option value="Pending">Pending</option>
    <option value="Cancelled">Cancelled</option>
  </select>
  <button onclick="clearFilters()">Clear</button>
</div>

<!-- STATS CARDS -->
<div class="stats-scroll">
  <div class="stats-card today">
    <h3>Today</h3>
    <p><strong>Orders:</strong> {{ totals['Today'].count }}</p>
    <p><strong>COD:</strong> â‚¹{{ totals['Today'].cod_amount }}</p>
    <p><strong>Online:</strong> â‚¹{{ totals['Today'].online_amount }}</p>
    <hr>
    <p><strong>Total:</strong> â‚¹{{ totals['Today'].cod_amount + totals['Today'].online_amount }}</p>
  </div>

  <div class="stats-card yesterday">
    <h3>Yesterday</h3>
    <p><strong>Orders:</strong> {{ totals['Yesterday'].count }}</p>
    <p><strong>COD:</strong> â‚¹{{ totals['Yesterday'].cod_amount }}</p>
    <p><strong>Online:</strong> â‚¹{{ totals['Yesterday'].online_amount }}</p>
    <hr>
    <p><strong>Total:</strong> â‚¹{{ totals['Yesterday'].cod_amount + totals['Yesterday'].online_amount }}</p>
  </div>

  <div class="stats-card older">
    <h3>Older</h3>
    <p><strong>Orders:</strong> {{ totals['Older'].count }}</p>
    <p><strong>COD:</strong> â‚¹{{ totals['Older'].cod_amount }}</p>
    <p><strong>Online:</strong> â‚¹{{ totals['Older'].online_amount }}</p>
    <hr>
    <p><strong>Total:</strong> â‚¹{{ totals['Older'].cod_amount + totals['Older'].online_amount }}</p>
  </div>
</div>

<!-- ORDER CARDS -->
{% for day in ['Today','Yesterday','Older'] %}
<h2>{{ day }} Orders</h2>
{% set day_orders = history|selectattr("day_category","equalto",day)|list %}
{% if day_orders %}
  {% for order in day_orders %}
  <div class="order-card" data-search="{{ order.order_id }} {{ order.customer_name }} {{ order.phone }}" data-status="{{ order.status }}">
    <span class="status-badge">{{ order.status }}</span>
    <h3>Order #{{ order.order_id }} â€“ {{ order.restaurant.name }}</h3>
    <p><strong>Customer:</strong> {{ order.customer_name }}</p>
    <p><strong>Phone:</strong> {{ order.phone }} | {{ order.alt_phone or '-' }}</p>
    <div class="address">
      <strong>Address:</strong><br>
      {{ order.house_no }}, {{ order.landmark }}, {{ order.city }}, {{ order.state }} - {{ order.pincode }}
    </div>
    <p><strong>Order Type:</strong> {{ order.order_type }}</p>
    <p><strong>Items:</strong></p>
    <ul>
      {% for item in order.items %}
      <li>{{ item.item_name }} Ã— {{ item.quantity }} â€“ â‚¹{{ item.price }}</li>
      {% endfor %}
    </ul>
    <p><strong>Total:</strong> â‚¹{{ order.get_final_total() }}</p>
    <p><strong>Delivery Charge:</strong> â‚¹{{ order.delivery_charge }}</p>
    <p><strong>Payment:</strong>
      {% if order.payment_type == 'COD' %}
      <span class="payment-badge COD">COD</span>
      {% elif order.payment_type == 'Online' %}
      <span class="payment-badge Online">Online</span>
      {% else %}
      <span class="payment-badge NotCollected">Not Collected</span>
      {% endif %}
    </p>
    <p><strong>Delivered At:</strong>
      {% if order.delivered_time %}
        {{ order.delivered_time.strftime('%d-%m-%Y %I:%M %p') }}
      {% else %}-{% endif %}
    </p>
  </div>
  {% endfor %}
{% else %}
<p>No {{ day.lower() }} orders.</p>
{% endif %}
{% endfor %}

</div>

<script>
// FILTER FUNCTION
function applyFilters(){
  const search = document.getElementById("searchInput").value.toLowerCase();
  const status = document.getElementById("statusFilter").value.toLowerCase();

  document.querySelectorAll(".order-card").forEach(card=>{
    const rowSearch = (card.dataset.search || "").toLowerCase();
    const rowStatus = (card.dataset.status || "").toLowerCase();

    let visible = true;

    if(search && !rowSearch.includes(search)) visible = false;
    if(status && rowStatus !== status) visible = false;

    card.style.display = visible ? "" : "none";
  });
}

// EVENTS
document.getElementById("searchInput").addEventListener("keyup", applyFilters);
document.getElementById("statusFilter").addEventListener("change", applyFilters);

function clearFilters(){
  document.getElementById("searchInput").value="";
  document.getElementById("statusFilter").value="";
  applyFilters();
}
</script>

</body>
</html>
