
@app.route("/place_order", methods=["POST"])
def place_order():
    # -------- BASIC DETAILS --------
    name = request.form.get("name")
    phone = request.form.get("phone")
    email = request.form.get("email")
    alt_phone = request.form.get("alt_phone")
    payment_type = request.form.get("payment_type")

    address_type = request.form.get("address_type")
    house_no = request.form.get("house_no")
    landmark = request.form.get("landmark")
    city = request.form.get("city")
    state = request.form.get("state")
    pincode = request.form.get("pincode")
    delivery_note = request.form.get("delivery_note")

    restaurant_id = int(request.form.get("restaurant_id"))
    map_link = request.form.get("map_link")
    device_fingerprint = request.form.get("device_fingerprint")

    # -------- ITEMS --------
    item_names = request.form.getlist("item_name[]")
    quantities = request.form.getlist("quantity[]")
    prices = request.form.getlist("price[]")

    if not item_names:
        flash("Cart is empty", "danger")
        return redirect("/")

    restaurant = Restaurant.query.get_or_404(restaurant_id)

    # -------- CHECK RESTAURANT OPEN --------
    if not is_restaurant_open(restaurant):
        flash("Restaurant is currently closed. Please try again later.", "danger")
        return redirect(url_for("menu", restaurant_id=restaurant_id))

    # -------- CALCULATE ITEMS TOTAL --------
    items_total = sum(int(quantities[i]) * float(prices[i]) for i in range(len(item_names)))

    # -------- DELIVERY CHARGE --------
    delivery_charge = restaurant.delivery_charge or 0
    if restaurant.free_delivery_limit and items_total >= restaurant.free_delivery_limit:
        delivery_charge = 0

    # -------- SYNC SESSION --------
    session["phone"] = phone
    session["device_fingerprint"] = device_fingerprint

    # -------- RESTAURANT OFFER --------
    offer_discount = 0
    offer_used = None
    previous_offer_order = None
    active_offer = RestaurantOffer.query.filter_by(
        restaurant_id=restaurant_id, is_active=True
    ).first()

    if active_offer:
        # Check if offer already used
        previous_offer_order = Order.query.filter(
            Order.restaurant_id == restaurant_id,
            ((Order.phone == phone) | (Order.device_fingerprint == device_fingerprint)),
            Order.restaurant_offer_id == active_offer.id
        ).first()

        # Only apply offer if not used before and items_total >= min_order_amount
        min_order = active_offer.min_order_amount or 0
        if not previous_offer_order and items_total >= min_order:
            offer_used = active_offer
            offer_type = active_offer.offer_type.lower()

            if offer_type == "percent":
                offer_discount = (items_total * active_offer.offer_value) / 100
            elif offer_type == "flat":
                offer_discount = active_offer.offer_value
            elif offer_type == "free_delivery":
                # Free delivery offer threshold
                threshold = min_order or restaurant.free_delivery_limit
                if items_total >= threshold:
                    delivery_charge = 0

    # -------- COUPON --------
    coupon_discount = 0
    coupon_used = None
    apply_coupon = request.form.get("apply_coupon")
    delivered_orders = Order.query.filter(
        ((Order.phone == phone) | (Order.device_fingerprint == device_fingerprint)),
        func.lower(Order.status) == "delivered"
    ).count()
    first_time_user = delivered_orders == 0

    if offer_discount == 0 and apply_coupon == "true" and first_time_user and items_total >= 199:
        coupon_discount = min(items_total * 0.30, 60)
        coupon_used = "FIRST30"

    # -------- TOTAL DISCOUNT & FINAL TOTAL --------
    total_discount = offer_discount + coupon_discount
    final_total = round(items_total + delivery_charge - total_discount, 2)

    # -------- GENERATE OTP --------
    order_otp = generate_otp()

    # -------- CREATE ORDER --------
    new_order = Order(
        restaurant_id=restaurant_id,
        customer_name=name,
        phone=phone,
        email=email,
        alt_phone=alt_phone,
        house_no=house_no,
        landmark=landmark,
        city=city,
        state=state,
        pincode=pincode,
        address_type=address_type,
        delivery_note=delivery_note,
        payment_type=payment_type,
        device_fingerprint=device_fingerprint,
        items_total=items_total,
        discount=coupon_discount,
        restaurant_offer_discount=offer_discount,
        restaurant_offer_id=offer_used.id if offer_used else None,
        delivery_charge=delivery_charge,
        final_total=final_total,
        coupon_used=coupon_used,
        map_link=map_link,
        otp=order_otp
    )
    db.session.add(new_order)
    db.session.commit()

    # -------- SET ORDER CODE --------
    new_order.order_id = generate_order_code(new_order.id)
    db.session.commit()

    # -------- ADD ORDER ITEMS --------
    for i in range(len(item_names)):
        qty = int(quantities[i])
        if qty > 0:
            db.session.add(OrderItem(
                order_id=new_order.id,
                item_name=item_names[i],
                quantity=qty,
                price=float(prices[i])
            ))
    db.session.commit()

    flash(f"Order placed successfully! Order ID: {new_order.order_id}", "success")
    return redirect(url_for("myorders", restaurant_id=restaurant_id))