{% extends "base.html" %}

{# üö´ Disable bottom navigation on this page #}
{% block bottom_nav %}{% endblock %}

{% block content %}


<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  /* =====================
   GLOBAL
===================== */
* {
    box-sizing: border-box;
}

body {
    font-family: Inter, system-ui, sans-serif;
    background: #f4f6f8;
    margin: 0;
    color: #333;
}

.container {
    max-width: 1300px;
    margin: 20px auto;
    padding: 15px;
}

h1 {
    color: #ff5722;
    text-align: center;
    margin-bottom: 20px;
}

/* =====================
   BUTTONS
===================== */
.btn {
    background: linear-gradient(135deg, #2196f3, #42a5f5);
    color: #fff;
    padding: 10px 18px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 700;
    display: inline-block;
    margin-bottom: 15px;
}

.btn:hover {
    opacity: 0.9;
}

/* =====================
   TABLE (DESKTOP)
===================== */
table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
}

thead {
    background: linear-gradient(135deg, #ff5722, #ff7043);
    color: #fff;
}

th, td {
    padding: 12px;
    font-size: 13px;
    text-align: center;
}

tbody tr {
    transition: 0.2s;
}

tbody tr:hover {
    background: #fff3e0;
}

/* =====================
   ITEMS LIST
===================== */
ul {
    margin: 0;
    padding-left: 15px;
    text-align: left;
}

ul li {
    font-size: 12px;
}

/* =====================
   INPUTS & SELECT
===================== */
.otp-input,
select {
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 14px;
    width: 100%;
    margin-bottom: 8px;
}

.otp-input:focus,
select:focus {
    outline: none;
    border-color: #ff5722;
    box-shadow: 0 0 6px rgba(255, 87, 34, 0.3);
}

/* =====================
   DELIVER BUTTON
===================== */
.deliver-btn {
    background: linear-gradient(135deg, #4caf50, #66bb6a);
    color: #fff;
    border: none;
    padding: 12px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    width: 100%;
    font-size: 15px;
}

/* =====================
   ERROR
===================== */
.otp-error {
    color: #f44336;
    font-size: 12px;
    display: none;
}

/* =====================
   MAP & CALL
===================== */
.map-btn,
.call-btn {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 10px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 700;
    color: #fff;
}

.map-btn {
    background: linear-gradient(135deg, #03a9f4, #29b6f6);
}

.call-btn {
    background: linear-gradient(135deg, #4caf50, #66bb6a);
}

/* =====================
   TOAST
===================== */
.toast {
    position: fixed;
    bottom: 30px;
    right: 20px;
    background: linear-gradient(135deg, #4caf50, #66bb6a);
    color: #fff;
    padding: 14px 20px;
    border-radius: 14px;
    font-weight: 700;
    opacity: 0;
    transform: translateY(20px);
    transition: 0.3s;
    z-index: 9999;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

/* =====================
   MOBILE CARD UI + HIGHLIGHTS
===================== */
@media (max-width: 768px) {

    /* Mobile card layout */
    table {
        display: block;
        background: transparent;
        box-shadow: none;
    }

    thead {
        display: none;
    }

    tbody, tr {
        display: block;
        width: 100%;
    }

    tr {
        background: #fff;
        margin-bottom: 15px;
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    td {
        display: block;
        font-size: 14px;
        padding: 6px 0;
        border: none;
        text-align: left;
    }

    /* Show labels */
    td::before {
        content: attr(data-label) " : ";
        font-weight: 700;
        color: #555;
    }

    /* üî• Order ID */
    td[data-label="Order ID"] {
        color: #ff5722;
        font-weight: 800;
        font-size: 16px;
    }

    /* üí∞ Money */
    td[data-label="Total"],
    td[data-label="Delivery Charge"] {
        color: #2e7d32;
        font-weight: 700;
    }

    /* üìç Address */
    td[data-label="Address"] {
        background: #f9fafb;
        padding: 10px;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        margin: 6px 0;
    }

    /* üìû Phone */
    td[data-label="Phone"],
    td[data-label="Alt Phone"] {
        color: #1565c0;
        font-weight: 600;
    }

    /* üçΩ Items */
    td[data-label="Items"] ul li {
        font-size: 13px;
        color: #444;
    }

    /* üöö Status */
    td[data-label="Status"] {
        font-weight: 700;
        color: #6a1b9a;
    }

    /* ‚ö†Ô∏è Note */
    td[data-label="Note"] {
        color: #e65100;
        font-weight: 600;
    }

    /* Buttons */
    .map-btn,
    .call-btn {
        margin-top: 6px;
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 10px;
    }

    /* Confirm button */
    .deliver-btn {
        margin-top: 10px;
        font-size: 16px;
        padding: 14px;
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(67, 160, 71, 0.35);
    }
}
.filter-bar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:15px;
}

.filter-bar input,
.filter-bar select{
  flex:1;
  min-width:140px;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:14px;
}

.filter-bar button{
  background:#ff5722;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  font-weight:600;
}
/* Modal backdrop */
.modal {
  display: none; /* hidden by default */
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}

/* Card */
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  text-align: center;
}

/* Textarea */
.modal-content textarea {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 12px;
  font-size: 14px;
  resize: none;
}

/* Buttons */
.modal-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 15px;
}

.modal-buttons button {
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

#cancelBtn {
  background: #ccc;
  color: #000;
}

#submitBtn {
  background: #f44336;
  color: #fff;
}
/* TOAST / FLASH CARD */
.toast {
  position: fixed;
  bottom: 70px; /* above bottom nav */
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: #323232;
  color: #fff;
  padding: 12px 18px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  opacity: 0;
  pointer-events: none;
  z-index: 99999;
  transition: all 0.3s ease;
}

/* Success */
.toast.success {
  background: #2e7d32;
}

/* Error */
.toast.error {
  background: #d32f2f;
}

/* Visible */
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

</style>



</head>

<body>
<div class="container">

<h1>Delivery Dashboard - {{ session.delivery_person_name }}</h1>

<a href="{{ url_for('delivery_history') }}" class="btn">History</a>
<a href="{{ url_for('delivery_logout') }}" class="btn">Logout</a>

<h2>Assigned Orders</h2>
<div class="filter-bar">
  <input type="text" id="searchInput" placeholder="üîç Order ID / Customer / Phone">

<select id="statusFilter">
  <option value="">All Status</option>
  <option value="Pending">Pending</option>
  <option value="Out for Delivery">Out for Delivery</option>
  <option value="Delivered">Delivered</option>
  <option value="Cancelled">Cancelled</option>
  <option value="Customer Not Available">Customer Not Available</option>
</select>


  <select id="paymentFilter">
    <option value="">All Payments</option>
    <option value="COD">COD</option>
    <option value="Online">Online</option>
  </select>

  <button onclick="clearFilters()">Clear</button>
</div>


 
<table>
  <thead>
    <tr>
      <th>Order ID</th>
      <th>Date & Time</th>
      <th>Restaurant</th>
      <th>Customer</th>
      <th>Phone</th>
      <th>Alt Phone</th>
      <th>Address</th>
      <th>Order Type</th>
      <th>Items</th>
      <th>Total</th>
      <th>Delivery Charge</th>
      <th>Delivery Note</th>
      <th>Map</th>
      <th>Call</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>

  <tbody>
  {% for order in orders %}
    <tr
      data-order-id="{{ order.id }}"
      data-search="{{ order.order_id }} {{ order.customer_name }} {{ order.phone }}"
      data-status="{{ order.status }}"
      data-payment="{{ order.payment_type or '' }}"
    >
      <td data-label="Order ID">{{ order.order_id }}</td>

      <td data-label="Date & Time">
        {{ order.created_at.strftime('%d-%m-%Y %I:%M %p') }}
      </td>

      <td data-label="Restaurant">{{ order.restaurant.name }}</td>
      <td data-label="Customer">{{ order.customer_name }}</td>
      <td data-label="Phone">{{ order.phone }}</td>
      <td data-label="Alt Phone">{{ order.alt_phone or '-' }}</td>

      <td data-label="Address">
        {{ order.house_no }},
        {{ order.landmark }},
        {{ order.city }},
        {{ order.state }} - {{ order.pincode }}
      </td>

      <td data-label="Order Type">{{ order.order_type }}</td>

      <td data-label="Items">
        <ul>
          {% for item in order.items %}
            <li>{{ item.item_name }} √ó {{ item.quantity }} ‚Äì ‚Çπ{{ item.price }}</li>
          {% endfor %}
        </ul>
      </td>

      <td data-label="Total">‚Çπ{{ order.final_total }}</td>
      <td data-label="Delivery Charge">‚Çπ{{ order.delivery_charge }}</td>
      <td data-label="Note">{{ order.delivery_note or '-' }}</td>

      <td data-label="Map">
        {% if order.map_link %}
          <a href="{{ order.map_link }}" target="_blank" class="map-btn">Map</a>
        {% else %}
          <span style="color:red">No Location</span>
        {% endif %}
      </td>

      <td data-label="Call">
        <a href="tel:{{ order.phone }}" class="call-btn">Call</a>
      </td>

      <td data-label="Status">
        {{ order.status }}
        {% if order.status == 'Delivered' and order.delivered_time %}
          <br>
          <small style="color:green">
            {{ order.delivered_time.strftime('%d-%m-%Y %I:%M %p') }}<br>
            Payment: {{ order.payment_type }}
          </small>
        {% endif %}

    <td data-label="Action">

{% if order.status == "Out for Delivery" %}

  <!-- Start Delivery Button -->
  <button class="deliver-btn"
          id="start-btn-{{ order.id }}"
          onclick="startDelivery({{ order.id }})">
    üöÄ Start Delivery
  </button>

  <!-- OTP + Payment + Customer Not Available (hidden initially) -->
  <div class="delivery-actions" id="actions-{{ order.id }}" style="display:none; margin-top:8px;">

    <form class="deliver-form"
          method="POST"
          action="{{ url_for('delivery_dashboard') }}">
      <input type="hidden" name="order_id" value="{{ order.id }}">
      <input type="text" name="otp" class="otp-input" placeholder="Enter OTP" required>
      <select name="payment_type" required>
        <option value="">Payment Type</option>
        <option value="COD">COD</option>
        <option value="Online">Online</option>
      </select>
      <button type="submit" class="deliver-btn">‚úî Confirm Delivery</button>
    </form>

    <!-- Customer Not Available Button -->
    <button type="button"
            class="deliver-btn"
            style="background:#f44336; margin-top:6px;"
            onclick="markNotDelivered({{ order.id }})">
      Customer Not Available
    </button>

  </div>

{% elif order.status == "Started" %}

  <span style="color:blue;font-weight:bold">üöö Delivery Started</span>

  <!-- Show OTP + Customer Not Available (already visible for started orders) -->
  <div class="delivery-actions" id="actions-{{ order.id }}" style="display:block; margin-top:8px;">

    <form class="deliver-form"
          method="POST"
          action="{{ url_for('delivery_dashboard') }}">
      <input type="hidden" name="order_id" value="{{ order.id }}">
      <input type="text" name="otp" class="otp-input" placeholder="Enter OTP" required>
      <select name="payment_type" required>
        <option value="">Payment Type</option>
        <option value="COD">COD</option>
        <option value="Online">Online</option>
      </select>
      <button type="submit" class="deliver-btn">‚úî Confirm Delivery</button>
    </form>

    <button type="button"
            class="deliver-btn"
            style="background:#f44336; margin-top:6px;"
            onclick="markNotDelivered({{ order.id }})">
      Customer Not Available
    </button>

  </div>

{% elif order.status == "Delivered" %}

  <span style="color:green;font-weight:bold">‚úî Delivered</span>

{% elif order.status == "Cancelled" %}

  <span style="color:red;font-weight:bold">‚ùå Cancelled</span>

{% else %}

  <span style="color:gray;font-style:italic;">{{ order.status }}</span>

{% endif %}

</td>


      





    </tr>
  {% endfor %}
  </tbody>
</table>
<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Socket.IO only if delivery page -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
let ORDER_ID = null;
let ACTIVE_ORDER_ID = null;
let watchId = null;
let map = null;
let customerMarker = null;
let deliveryMarker = null;

// ===== SOCKET.IO =====
let socket = null;
{% if orders|length > 0 %}
socket = io();
socket.on("connect", () => {
    console.log("üü¢ Delivery connected:", socket.id);
    {% for order in orders %}
    socket.emit("join_order_room", { order_id: ORDER_ID });

    {% endfor %}
});
{% endif %}

// ===== START DELIVERY =====
function startDelivery(orderId) {
    console.log("üöÄ startDelivery called for order:", orderId);

    ACTIVE_ORDER_ID = orderId;
    ORDER_ID = orderId;

    // Call backend to mark order as Started
    fetch(`/delivery/start/${orderId}`, { method:"POST" })
        .then(res => res.json())
        .then(data => {
            if(data.success) console.log("Order marked as Started");
        });

    // Hide start button
    const btn = document.getElementById(`start-btn-${orderId}`);
    if(btn) btn.style.display = "none";

    // Show wrapper div containing OTP + "Customer Not Available"
    const actionsDiv = document.getElementById(`actions-${orderId}`);
    if(actionsDiv) actionsDiv.style.display = "block";

    // Start GPS tracking
    startTracking(orderId);
}

// ===== GPS TRACKING =====
function startTracking(orderId) {
    if (!navigator.geolocation) { alert("GPS not supported"); return; }
    if (watchId !== null) { alert("Tracking already started"); return; }
    if (!ORDER_ID || !socket) { alert("No active order to track"); return; }

    watchId = navigator.geolocation.watchPosition(
        pos => {
            console.log("üì° GPS OK", pos.coords.latitude, pos.coords.longitude);
            socket.emit("delivery_location_update", {
                order_id: orderId,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            });

            if(map) {
                const latlng = [pos.coords.latitude, pos.coords.longitude];
                if(deliveryMarker) deliveryMarker.setLatLng(latlng);
                else {
                    deliveryMarker = L.marker(latlng, {
                        icon: L.icon({
                            iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                            iconSize: [30,30]
                        })
                    }).addTo(map).bindPopup("You (Delivery)").openPopup();
                }
            }
        },
        err => { console.error("‚ùå GPS ERROR", err); alert("Allow location access"); },
        { enableHighAccuracy:true, maximumAge:0 }
    );
}

// ===== CUSTOMER NOT AVAILABLE =====
// ===== CUSTOMER NOT AVAILABLE =====
function markNotDelivered(orderId) {
  const modal = document.getElementById("notDeliveredModal");
  const reasonInput = document.getElementById("notDeliveredReason");
  const cancelBtn = document.getElementById("cancelBtn");
  const submitBtn = document.getElementById("submitBtn");

  reasonInput.value = "";
  modal.style.display = "flex";

  cancelBtn.onclick = () => {
    modal.style.display = "none";
  };

  submitBtn.onclick = async () => {
    const reason = reasonInput.value.trim();

    // ‚ùå no alert
    if (!reason) {
      showToast("Please enter a reason", "error");
      return;
    }

    try {
      const res = await fetch(`/delivery/not-delivered/${orderId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reason })
      });

      const data = await res.json();

     if (data.success) {
      showToast("Order moved to history", "success");

      // Remove order card from active list
      const orderCard = document.getElementById(`order-${orderId}`);
      if (orderCard) orderCard.remove();

      // Switch to history tab
      setTimeout(() => {
        showHistory();
      }, 800);


      } else {
        showToast(data.message || "Failed to update order", "error");
      }

    } catch (e) {
      showToast("Server error. Try again later", "error");
    } finally {
      modal.style.display = "none";
    }
  };
}

function showToast(message, type = "success") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = `toast ${type} show`;

  setTimeout(() => {
    toast.classList.remove("show");
  }, 2500); // auto hide
}


// ===== INITIALIZE MAP =====
{% if orders|length > 0 %}
const customerLat = {{ orders[0].latitude | default('null') | tojson }};
const customerLng = {{ orders[0].longitude | default('null') | tojson }};

if (customerLat !== null && customerLng !== null) {
    const mapDiv = document.getElementById("map");
    if (mapDiv) {
        map = L.map("map").setView([customerLat, customerLng], 14);
        customerMarker = L.marker([customerLat, customerLng])
                          .addTo(map)
                          .bindPopup("Customer")
                          .openPopup();

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "¬© OpenStreetMap"
        }).addTo(map);
    }
} else {
    const mapDiv = document.getElementById("map");
    if (mapDiv) mapDiv.innerHTML = "<p style='color:red;text-align:center;'>Customer location not available</p>";
}
{% endif %}
</script> 
<script> 
socket.on("connect", () => {
  socket.emit("join_delivery_room", {
    delivery_person_id: {{ session.delivery_person_id }}
  });
});

const orderSound = new Audio("{{ url_for('static', filename='sounds/new_delivery.mp3') }}");

document.addEventListener("click", () => {
  orderSound.play().then(() => {
    orderSound.pause();
    orderSound.currentTime = 0;
  }).catch(()=>{});
}, { once: true });

socket.on("new_order_assigned", (data) => {

  showToast("üì¶ New order assigned!", "success");

  orderSound.play().catch(()=>{});

  if (navigator.vibrate) {
    navigator.vibrate([200,100,200]);
  }

  setTimeout(() => {
    location.reload();
  }, 2000);
});
</script>



<!-- Customer Not Available Modal -->
<div id="notDeliveredModal" class="modal">
  <div class="modal-content">
    <h3>Customer Not Available</h3>
    <textarea id="notDeliveredReason" placeholder="Reason (Customer not available / Phone switched off)" rows="3"></textarea>
    <div class="modal-buttons">
      <button id="cancelBtn">Cancel</button>
      <button id="submitBtn">Submit</button>
    </div>
  </div>
</div>
<!-- Toast Notification -->
<div id="toast" class="toast"></div>

{% endblock %}