

{% extends "base.html" %}

{% block title %}Track order{% endblock %}

{% block content %} 
<a href="{{ url_for('myorders') }}" id="backBtn">
  ‚Üê My Orders
</a>

<h3>Live Delivery Tracking</h3>
<p>Delivery Boy: {{ order.delivery_person.name if order.delivery_person else "Not Assigned" }}</p>

<div id="mapWrapper">
  <div id="map"></div>
  <!-- Routing wrapper -->
  <div id="routingWrapper"></div>
</div>

<div id="infoBox" class="above-bottom-nav">
  üöö Distance & ETA
</div>

<style>
html, body { height:100%; margin:0; }

#mapWrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: calc(47px + env(safe-area-inset-bottom));
  z-index: 1;
}

#map { height: 100%; width: 100%; }

#backBtn {
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 3000; /* above routing button */
  background: #fff;
  color: #000;
  padding: 4px 6px;
  border-radius: 12px;
  font-weight: 300;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  text-decoration: none;
}

h3, p {
  position: fixed;
  left: 12px;
  background: rgba(255,255,255,0.6);
  display: inline-block;
  border-radius: 10px;
  padding: 4px 10px;
  z-index: 2000;
}
h3 { top: 60px; color: rgb(14,114,92); font-size:14px; }
p { top: 100px; color: rgb(14,114,92); font-size:12px; }

#infoBox {
  position: fixed;
  bottom: calc(57px + env(safe-area-inset-bottom) + 12px);
  left: 12px; right:12px;
  background: white;
  padding: 12px 14px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  z-index: 9999;
  font-size: 14px;
  text-align: center;
}

#routingWrapper {
  position: fixed;       /* stays on top of map */
  top: 50px;             /* above back button if needed */
  left: 50%;             /* center horizontally */
  transform: translateX(-50%);
  z-index: 2500;         /* above back button z-index */
}
/* Mobile - move to right */
@media (max-width: 768px) {
  #backBtn {
    top :135px;
    right: auto;         /* unset left 50% */
    left: 12px;        /* move to right */
    transform: none;    /* remove translate */
  }
}
</style>


<!-- 1Ô∏è‚É£ Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<!-- 2Ô∏è‚É£ Leaflet JS (MUST be first) -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- 3Ô∏è‚É£ Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<!-- 4Ô∏è‚É£ Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<!-- 5Ô∏è‚É£ Socket.IO -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>


<script>

document.addEventListener("DOMContentLoaded", () => {

  const socket = io(location.origin);
  const ORDER_ID = {{ order.id }};

  socket.on("connect", () => {
    socket.emit("join_order_room", { order_id: ORDER_ID });
  });

  const customerLat = {{ order.latitude | tojson }};
  const customerLng = {{ order.longitude | tojson }};

  if (customerLat === null || customerLng === null) {
    document.getElementById("map").innerHTML =
      "<p style='color:red'>Customer location not available</p>";
    return;
  }
setTimeout(() => {
  map.invalidateSize();
}, 300);

  /* MAP */
  const map = L.map("map").setView([customerLat, customerLng], 14);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  L.marker([customerLat, customerLng])
    .addTo(map)
    .bindPopup("Customer");

  let deliveryMarker = null;
  let routingControl = null;

  /* ROUTE */
  function drawRoute(delLat, delLng) {
    if (routingControl) map.removeControl(routingControl);

    routingControl = L.Routing.control({
      waypoints: [
        L.latLng(delLat, delLng),
        L.latLng(customerLat, customerLng)
      ],
      router: L.Routing.osrmv1({
        serviceUrl: "https://router.project-osrm.org/route/v1"
      }),
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      fitSelectedRoutes: true,
      show: false,
      lineOptions: {
        styles: [{ color: "#007bff", weight: 5 }]
      },
      createMarker: () => null
    }).addTo(map);
  }

  /* SOCKET UPDATE */
  socket.on("delivery_location_update", data => {
    if (!data || data.lat === null || data.lng === null) return;

    if (!deliveryMarker) {
      deliveryMarker = L.marker([data.lat, data.lng])
        .addTo(map)
        .bindPopup("Delivery Boy");
    } else {
      deliveryMarker.setLatLng([data.lat, data.lng]);
    }

    drawRoute(data.lat, data.lng);

    const distanceKm =
      map.distance([data.lat, data.lng], [customerLat, customerLng]) / 1000;

    document.getElementById("infoBox").innerHTML = `
      <b>Distance:</b> ${distanceKm.toFixed(2)} km<br>
      <b>ETA:</b> ${Math.round((distanceKm / 25) * 60)} mins
    `;
  });

});


</script>

</style>
{% endblock %}
