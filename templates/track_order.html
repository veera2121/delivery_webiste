<h3>Live Delivery Tracking</h3>
<p>Delivery Boy: {{ order.delivery_person.name if order.delivery_person else "Not Assigned" }}</p>

<div id="infoBox" style="margin:10px 0; font-weight:600;"></div>
<div id="map" style="height:350px;"></div>
<!-- 1ï¸âƒ£ Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<!-- 2ï¸âƒ£ Leaflet JS (MUST be first) -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- 3ï¸âƒ£ Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<!-- 4ï¸âƒ£ Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<!-- 5ï¸âƒ£ Socket.IO -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>


<script>
  
document.addEventListener("DOMContentLoaded", () => {

  const socket = io(location.origin);
  const ORDER_ID = {{ order.id }};

  socket.on("connect", () => {
    console.log("ðŸŸ¢ Customer connected:", socket.id);
    socket.emit("join_order_room", { order_id: ORDER_ID });
  });

  const customerLat = {{ (order.latitude | default(None)) | tojson }};
  const customerLng = {{ (order.longitude | default(None)) | tojson }};

  if (isNaN(customerLat) || isNaN(customerLng)) {
    document.getElementById("map").innerHTML =
      "<p style='color:red'>Customer location not available</p>";
    return;
  }

  /* ================= MAP ================= */
  const map = L.map("map").setView([customerLat, customerLng], 14);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  const customerMarker = L.marker([customerLat, customerLng])
    .addTo(map)
    .bindPopup("Customer");

  let deliveryMarker = null;
  let routingControl = null;

  /* ================= ROUTE FUNCTION ================= */
  function drawRoute(delLat, delLng) {
    if (routingControl) {
      map.removeControl(routingControl);
    }

    routingControl = L.Routing.control({
      waypoints: [
        L.latLng(delLat, delLng),
        L.latLng(customerLat, customerLng)
      ],
      routeWhileDragging: false,
      addWaypoints: false,
      draggableWaypoints: false,
      show: false,
      fitSelectedRoutes: true,
      lineOptions: {
        styles: [{ color: "#1e90ff", weight: 5 }]
      },
      createMarker: () => null
    }).addTo(map);
  }

  /* ================= SOCKET ================= */
  socket.on("delivery_location_update", data => {
    if (!data || isNaN(data.lat) || isNaN(data.lng)) return;

    if (!deliveryMarker) {
      deliveryMarker = L.marker([data.lat, data.lng])
        .addTo(map)
        .bindPopup("Delivery Boy");
    } else {
      deliveryMarker.setLatLng([data.lat, data.lng]);
    }

    drawRoute(data.lat, data.lng);

    const distanceKm = map.distance(
      [data.lat, data.lng],
      [customerLat, customerLng]
    ) / 1000;

    document.getElementById("infoBox").innerHTML = `
      <b>Distance:</b> ${distanceKm.toFixed(2)} km<br>
      <b>ETA:</b> ${Math.round((distanceKm / 25) * 60)} mins
    `;
  });

});
</script>


<style>
#map {
  height: 350px !important;
  width: 100%;
  border-radius: 10px;
}
</style>
