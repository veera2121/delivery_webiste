<div class="restaurant-row">
{% for r in restaurants %}

    {# ================= BASIC FLAGS ================= #}
    {% set is_open = (
        r.opening_time and r.closing_time and
        r.opening_time <= now <= r.closing_time
    ) %}
    {% set is_suspended = (r.status == 'suspended') %}
    {% set is_coming_soon = (r.status == 'coming_soon') %}
    {% set can_accept = r.can_accept_orders %}

    <div class="card
        {% if is_suspended or not can_accept or not r.deliverable or not is_open %}
            disabled
        {% endif %}
    "
    {% if can_accept and r.deliverable and is_open %}
        onclick="window.location.href='/menu/{{ r.id }}'"
    {% endif %}
    >

        {# ================= STATUS BANNERS ================= #}

        {% if is_suspended %}
            <div class="info-box suspended-box">
                üö´ Temporarily unavailable
            </div>

        {% elif is_coming_soon %}
            <div class="info-box coming-soon-box">
                ‚è≥ Coming Soon
                {% if r.start_date %}
                    <br>
                    Starts on {{ r.start_date.strftime("%d %b %Y") }}
                {% endif %}
            </div>
        {% endif %}

        {# ================= DELIVERY CHECK ================= #}
        {% if not r.deliverable %}
            <div class="info-box not-deliverable">
                üö´ Not delivering to your location
            </div>
        {% endif %}

        {# ================= TIME STATUS ================= #}
        {% if not is_suspended and not is_coming_soon %}

            {% if not r.opening_time or not r.closing_time %}
                <div class="info-box closed-box">
                    ‚ùå Closed ‚Äî Timing not updated
                </div>

            {% elif now < r.opening_time %}
                <div class="info-box closed-box">
                    ‚è≥ Opens today at {{ r.opening_time.strftime("%I:%M %p") }}
                </div>

            {% elif now > r.closing_time %}
                <div class="info-box closed-box">
                    üåô Closed for today ‚Äî Opens tomorrow
                </div>
            {% endif %}

        {% endif %}

        {# ================= OFFER ================= #}
        {% if r.active_offer and r.deliverable and is_open and can_accept %}
            <div class="info-box offer-box">
                üî• {{ r.active_offer.title }} ‚Äî {{ r.active_offer.description }}
            </div>
        {% endif %}

        {# ================= IMAGE ================= #}
        <img 
            src="/static/images/restaurants/{{ r.id }}.jpg"
            alt="{{ r.name }}"
            onerror="this.onerror=null; this.src='/static/images/restaurants/img1.jpg';"
        >

        {# ================= CONTENT ================= #}
        <div class="content">

            <div class="restaurant-name">{{ r.name }}</div>

            {% if r.is_veg %}
                <div class="veg-badge">Veg</div>
            {% else %}
                <div class="nonveg-badge">Non-Veg</div>
            {% endif %}

            <div class="details">
                <div class="rating">{{ r.rating }} ‚≠ê</div>
                <div class="price">{{ r.price_level }}</div>
                <div class="time">{{ r.delivery_time }}</div>
            </div>

            <div class="popular">üçΩÔ∏è {{ r.popular_items }}</div>

            {% if r.free_delivery_limit > 0 %}
                <div class="free-delivery">
                    üöö Free Delivery on ‚Çπ{{ r.free_delivery_limit }}+
                </div>
            {% else %}
                <div class="delivery-charge">
                    üöö Delivery ‚Çπ{{ r.delivery_charge }}
                </div>
            {% endif %}
            

{# ================= ACTION BUTTON ================= #}
            {% if is_suspended %}
                <span class="view-btn disabled-btn">Suspended</span>

            {% elif is_coming_soon %}
                <span class="view-btn disabled-btn">
                    Coming Soon
                    {% if r.start_date %}
                        ({{ r.start_date.strftime("%d %b") }})
                    {% endif %}
                </span>

            {% elif not r.opening_time or not r.closing_time %}
                <span class="view-btn disabled-btn">Timing not updated</span>

            {% elif not is_open %}
                {% if now < r.opening_time %}
                    <span class="view-btn disabled-btn">
                        Accepting orders at {{ r.opening_time.strftime("%I:%M %p") }}
                    </span>
                {% else %}
                    <span class="view-btn disabled-btn">
                        Closed for today
                    </span>
                {% endif %}

            {% elif not can_accept %}
                {% if r.accept_orders_until and now < r.accept_orders_until %}
                    <span class="view-btn disabled-btn">
                        ‚è≥ Accepting orders Until {{ r.accept_orders_until.strftime("%I:%M %p") }}
                    </span>
                {% else %}
                    <span class="view-btn disabled-btn">
                        ‚è≥ Orders will reopen soon ‚Äî stay tuned!
                    </span>
                {% endif %}

            {% elif not r.deliverable %}
                <span class="view-btn disabled-btn">
                    Not delivering to your location
                </span>

            {% else %}
                <a href="/menu/{{ r.id }}" class="view-btn">View Menu</a>
            {% endif %}

        </div>   <!-- ‚úÖ CLOSE .content -->
    </div>       <!-- ‚úÖ CLOSE .card -->

{% endfor %}
</div>           <!-- ‚úÖ CLOSE .restaurant-row -->

{% if trending_items|length > 0 %}
<section class="trending-section">
    <h2>üî• Trending in {{ selected_location }}</h2>

    <div class="trending-grid">
        {% for item in trending_items %}
        <div class="food-card">
            <span class="badge">üî• Trending</span>
            <h4>{{ item.name }}</h4>
            <p>‚Çπ{{ item.price }}</p>
            <small>
                From {{ item.restaurant.name if item.restaurant else "Unknown" }}
            </small>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
